[**@-xun/api**](../../README.md)

***

[@-xun/api](../../README.md) / [types](../README.md) / MiddlewareContext

# Type Alias: MiddlewareContext\<Options, Heap, Middleware\>

> **MiddlewareContext**\<`Options`, `Heap`, `Middleware`\> = `object`

Defined in: [packages/api/src/types.ts:165](https://github.com/Xunnamius/api-utils/blob/2999e4472bea4c5a8ecd8f7c7fbf77e6b4bc26db/packages/api/src/types.ts#L165)

The shape of a middleware context object, potentially customized with
additional middleware-specific options.

Middleware functions should be order-agnostic. That is: the system should not
crash simply because the order of middleware functions (before or after the
handler executes respectively) changes.

## Type Parameters

### Options

`Options` *extends* `Record`\<`string`, `unknown`\>

### Heap

`Heap` *extends* `Record`\<`PropertyKey`, `unknown`\>

### Middleware

`Middleware` *extends* [`AnyMiddleware`](AnyMiddleware.md)\<`Options`, `Heap`\>

## Properties

### heap

> **heap**: `Heap`

Defined in: [packages/api/src/types.ts:254](https://github.com/Xunnamius/api-utils/blob/2999e4472bea4c5a8ecd8f7c7fbf77e6b4bc26db/packages/api/src/types.ts#L254)

A context object meant to be written to and read by any middleware.

After all middleware is finished running, `heap` is passed to the handler
as its `ctx` parameter, allowing middleware and handlers to more easily
share data.

***

### options

> **options**: `Options` & `object`

Defined in: [packages/api/src/types.ts:258](https://github.com/Xunnamius/api-utils/blob/2999e4472bea4c5a8ecd8f7c7fbf77e6b4bc26db/packages/api/src/types.ts#L258)

Options expected by middleware functions at runtime.

#### Type declaration

##### awaitMiddlewareAfterSent

> **awaitMiddlewareAfterSent**: `boolean`

By default, modern usage of `withMiddleware` will return a
Response as soon as possible by _not_ awaiting the promises
generated by calling `doAfterSent()`.

To make testing easier, `withMiddleware` can be configured to await said
promises instead; when `true`, the `doAfterSent` middleware promises will
complete before the Response is returned or "sent" by this
function.

Do not enable this in production.

###### Default

```ts
false
```

##### callDoneOnEnd

> **callDoneOnEnd**: `boolean`

If `true` and `legacyMode` is also `true`, `context.runtime.done` is
called whenever `res.end()` is called before the middleware chain
completes execution.

If `false` (or if `legacyMode` is `false`), the entire primary middleware
chain will always run to completion, even if the response has already
been sent before it completes.

###### Default

```ts
true
```

##### legacyMode

> **legacyMode**: `boolean`

If `true`, the middleware assumes a legacy runtime environment (e.g.
Next.js Pages router or Express middleware). Otherwise, a modern runtime
environment is assumed (e.g. using Request and Response)

###### Default

```ts
false
```

***

### runtime

> **runtime**: `object`

Defined in: [packages/api/src/types.ts:173](https://github.com/Xunnamius/api-utils/blob/2999e4472bea4c5a8ecd8f7c7fbf77e6b4bc26db/packages/api/src/types.ts#L173)

Contains middleware use chain control functions and various metadata.

#### doAfterHandled()

> `readonly` **doAfterHandled**: (`middleware`) => `void`

Appends `middleware` to list of special internal middlewares that are
added and removed only by other middleware; they are not end-user facing.

Middleware with tasks that need to execute after the handler completes
successfully _but before the response is sent_ (e.g. cors) should add
those tasks via this function.

Tasks are always executed in order after the `use` middleware chain, the
handler, and/or the `useOnError` chain (when applicable) all execute
successfully.

**Unlike with `doAfterSent`, these internal middleware will ALWAYS delay
the server from responding to a request.**

Note that errors thrown by middleware added by this function are ignored.

##### Parameters

###### middleware

`UnwrapTagged`\<`Middleware`\>

##### Returns

`void`

#### doAfterSent()

> `readonly` **doAfterSent**: (`middleware`) => `void`

Appends `middleware` to list of special internal middlewares that are
added and removed only by other middleware; they are not end-user facing.

Middleware with tasks that need to execute after the handler completes
successfully _and after the response is sent_ (e.g. logging) should add
those tasks via this function.

Tasks are always executed in order after the `use` middleware chain, the
handler, and/or the `useOnError` chain (when applicable) all execute
successfully.

**Unlike with `doAfterHandled`, these internal middleware will NEVER
delay the server from responding to a request.**

Note that errors thrown by middleware added by this function are ignored.

##### Parameters

###### middleware

`UnwrapTagged`\<`Middleware`\>

##### Returns

`void`

#### done()

> `readonly` **done**: () => `void`

Stop calling middleware functions, effectively aborting execution of the
use chain. If a Response has not yet been returned (or
`response.end` hasn't been called if in legacy mode) before calling this
function, it will be called automatically. On abort, the handler will
also be skipped.

##### Returns

`void`

#### endpoint

> **endpoint**: `object`

Metadata describing the current endpoint.

##### endpoint.descriptor?

> `optional` **descriptor**: `string`

A parameterized path string in the form of a URI path corresponding to
the current endpoint. For example: `/my-endpoint/:some_id`.

Used for logging purposes only.

#### error

> `readonly` **error**: `unknown`

For middleware run via `useOnError` (and `postHandlerTasks`), the `error`
property will contain the thrown error object.

#### response

> `readonly` **response**: `Middleware` *extends* [`WithModernTag`](WithModernTag.md)\<`unknown`\> ? `Response` : `undefined`

For modern non-legacy middleware, this property contains the latest
Response instance returned by some earlier middleware or handler.

Once all middleware and handlers finish running, `response` is passed to
the server for final processing.

Note that mutating `response` in middleware added via `doAfterSent` will
have no effect.
